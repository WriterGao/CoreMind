# CoreMind 使用示例

本文档提供了常见使用场景的完整示例。

## 场景1: 构建本地文档问答系统

### 步骤1: 创建知识库

```python
import requests

API_URL = "http://localhost:8000/api/v1"
TOKEN = "your_access_token"

headers = {
    "Authorization": f"Bearer {TOKEN}",
    "Content-Type": "application/json"
}

# 创建知识库
kb_data = {
    "name": "技术文档库",
    "description": "公司内部技术文档",
    "embedding_model": "text-embedding-ada-002",
    "chunk_size": 1000,
    "chunk_overlap": 200
}

response = requests.post(f"{API_URL}/knowledge", json=kb_data, headers=headers)
kb = response.json()
kb_id = kb["id"]
print(f"知识库创建成功: {kb_id}")
```

### 步骤2: 上传文档

```python
# 上传单个文档
with open("technical_doc.pdf", "rb") as f:
    files = {"file": f}
    response = requests.post(
        f"{API_URL}/knowledge/{kb_id}/upload",
        files=files,
        headers={"Authorization": f"Bearer {TOKEN}"}
    )
    print(response.json())

# 批量上传
import os

doc_dir = "./documents"
for filename in os.listdir(doc_dir):
    if filename.endswith(('.pdf', '.docx', '.txt')):
        filepath = os.path.join(doc_dir, filename)
        with open(filepath, "rb") as f:
            files = {"file": f}
            response = requests.post(
                f"{API_URL}/knowledge/{kb_id}/upload",
                files=files,
                headers={"Authorization": f"Bearer {TOKEN}"}
            )
            print(f"上传 {filename}: {response.status_code}")
```

### 步骤3: 创建对话并提问

```python
# 创建对话
conv_data = {
    "title": "技术问答",
    "knowledge_base_id": kb_id,
    "system_prompt": "你是一个专业的技术顾问，基于提供的文档回答用户问题。",
    "model": "gpt-4"
}

response = requests.post(f"{API_URL}/chat/conversations", json=conv_data, headers=headers)
conv = response.json()
conv_id = conv["id"]

# 发送问题
message_data = {
    "message": "FastAPI的主要特点是什么？",
    "use_knowledge_base": True
}

response = requests.post(
    f"{API_URL}/chat/conversations/{conv_id}/messages",
    json=message_data,
    headers=headers
)
reply = response.json()
print(f"AI回复: {reply['content']}")
```

## 场景2: 集成外部API

### 创建天气查询接口

```python
# 创建API接口
interface_data = {
    "name": "查询天气",
    "description": "查询指定城市的天气信息",
    "type": "api",
    "config": {
        "url": "https://api.openweathermap.org/data/2.5/weather",
        "method": "GET",
        "headers": {},
        "param_mapping": {
            "q": "city",
            "appid": "api_key"
        }
    },
    "parameters": {
        "type": "object",
        "properties": {
            "city": {
                "type": "string",
                "description": "城市名称"
            },
            "api_key": {
                "type": "string",
                "description": "OpenWeather API密钥"
            }
        },
        "required": ["city", "api_key"]
    }
}

response = requests.post(f"{API_URL}/interfaces", json=interface_data, headers=headers)
interface = response.json()
interface_id = interface["id"]

# 执行接口
execute_data = {
    "parameters": {
        "city": "Beijing",
        "api_key": "your_openweather_api_key"
    }
}

response = requests.post(
    f"{API_URL}/interfaces/{interface_id}/execute",
    json=execute_data,
    headers=headers
)
result = response.json()
print(f"天气信息: {result}")
```

## 场景3: 数据库数据源集成

### 配置MySQL数据源

```python
# 创建数据库数据源
datasource_data = {
    "name": "用户数据库",
    "description": "MySQL用户数据",
    "type": "database",
    "config": {
        "db_type": "mysql",
        "host": "localhost",
        "port": 3306,
        "user": "root",
        "password": "password",
        "database": "myapp",
        "query": "SELECT * FROM users WHERE created_at >= '2024-01-01'",
        "title_column": "username",
        "content_columns": ["email", "profile", "bio"]
    },
    "sync_frequency": 60
}

response = requests.post(f"{API_URL}/datasources", json=datasource_data, headers=headers)
datasource = response.json()
datasource_id = datasource["id"]

# 手动同步
response = requests.post(f"{API_URL}/datasources/{datasource_id}/sync", headers=headers)
print(response.json())
```

## 场景4: 自定义Python函数

### 创建数据处理函数

```python
# 创建Python函数接口
code = """
def main(numbers):
    '''计算数字列表的统计信息'''
    if not numbers:
        return {"error": "列表为空"}
    
    return {
        "count": len(numbers),
        "sum": sum(numbers),
        "average": sum(numbers) / len(numbers),
        "min": min(numbers),
        "max": max(numbers)
    }
"""

interface_data = {
    "name": "数字统计",
    "description": "计算数字列表的统计信息",
    "type": "function",
    "code": code,
    "parameters": {
        "type": "object",
        "properties": {
            "numbers": {
                "type": "array",
                "items": {"type": "number"},
                "description": "数字列表"
            }
        },
        "required": ["numbers"]
    }
}

response = requests.post(f"{API_URL}/interfaces", json=interface_data, headers=headers)
interface = response.json()

# 执行函数
execute_data = {
    "parameters": {
        "numbers": [1, 2, 3, 4, 5, 10, 20]
    }
}

response = requests.post(
    f"{API_URL}/interfaces/{interface['id']}/execute",
    json=execute_data,
    headers=headers
)
print(response.json())
```

## 场景5: 网页爬虫数据源

### 配置网页爬虫

```python
# 创建爬虫数据源
datasource_data = {
    "name": "技术博客",
    "description": "爬取技术博客文章",
    "type": "web_crawler",
    "config": {
        "start_url": "https://blog.example.com",
        "max_depth": 2,
        "delay": 2,
        "same_domain_only": True,
        "include_patterns": ["/posts/", "/articles/"],
        "exclude_patterns": ["/admin/", "/login/"]
    },
    "sync_frequency": 1440  # 每天同步一次
}

response = requests.post(f"{API_URL}/datasources", json=datasource_data, headers=headers)
datasource = response.json()

# 开始爬取
response = requests.post(f"{API_URL}/datasources/{datasource['id']}/sync", headers=headers)
print(response.json())
```

## 场景6: 流式对话

### 实现流式响应

```python
import json

# 使用流式响应
message_data = {
    "message": "请详细解释一下FastAPI的异步特性",
    "stream": True,
    "use_knowledge_base": True
}

response = requests.post(
    f"{API_URL}/chat/conversations/{conv_id}/messages",
    json=message_data,
    headers=headers,
    stream=True
)

# 逐块处理响应
print("AI回复: ", end="")
for line in response.iter_lines():
    if line:
        line = line.decode('utf-8')
        if line.startswith('data: '):
            data = json.loads(line[6:])
            if 'content' in data:
                print(data['content'], end="", flush=True)
            elif data.get('done'):
                print()  # 换行
                break
```

## 场景7: 知识库搜索

### 直接搜索知识库

```python
# 搜索相关文档
search_data = {
    "query": "如何优化数据库查询性能？",
    "top_k": 3
}

response = requests.post(
    f"{API_URL}/knowledge/{kb_id}/search",
    json=search_data,
    headers=headers
)

results = response.json()
for i, result in enumerate(results, 1):
    print(f"\n结果 {i}:")
    print(f"相似度: {1 - result['distance']:.2%}")
    print(f"内容: {result['content'][:200]}...")
    print(f"来源: {result['metadata'].get('title', 'Unknown')}")
```

## 场景8: 完整的工作流程

### 构建客户服务系统

```python
import requests
import time

class CustomerServiceBot:
    def __init__(self, api_url, token):
        self.api_url = api_url
        self.headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        }
        self.kb_id = None
        self.conv_id = None
    
    def setup_knowledge_base(self, docs_path):
        """设置知识库"""
        # 创建知识库
        kb_data = {
            "name": "客服知识库",
            "description": "客户服务常见问题",
        }
        resp = requests.post(
            f"{self.api_url}/knowledge",
            json=kb_data,
            headers=self.headers
        )
        self.kb_id = resp.json()["id"]
        
        # 上传文档
        import os
        for filename in os.listdir(docs_path):
            filepath = os.path.join(docs_path, filename)
            with open(filepath, "rb") as f:
                files = {"file": f}
                requests.post(
                    f"{self.api_url}/knowledge/{self.kb_id}/upload",
                    files=files,
                    headers={"Authorization": self.headers["Authorization"]}
                )
        
        print(f"知识库设置完成: {self.kb_id}")
    
    def create_conversation(self):
        """创建对话"""
        conv_data = {
            "title": "客户咨询",
            "knowledge_base_id": self.kb_id,
            "system_prompt": "你是一个专业的客服助手，根据知识库内容准确回答客户问题。",
            "model": "gpt-3.5-turbo",
            "temperature": 0.3
        }
        resp = requests.post(
            f"{self.api_url}/chat/conversations",
            json=conv_data,
            headers=self.headers
        )
        self.conv_id = resp.json()["id"]
        print(f"对话创建完成: {self.conv_id}")
    
    def chat(self, message):
        """发送消息并获取回复"""
        msg_data = {
            "message": message,
            "use_knowledge_base": True
        }
        resp = requests.post(
            f"{self.api_url}/chat/conversations/{self.conv_id}/messages",
            json=msg_data,
            headers=self.headers
        )
        return resp.json()["content"]

# 使用示例
bot = CustomerServiceBot("http://localhost:8000/api/v1", "your_token")
bot.setup_knowledge_base("./customer_docs")
bot.create_conversation()

# 模拟客户咨询
questions = [
    "如何退款？",
    "配送需要多长时间？",
    "如何修改订单地址？"
]

for question in questions:
    print(f"\n客户: {question}")
    answer = bot.chat(question)
    print(f"客服: {answer}")
    time.sleep(1)
```

## 更多示例

查看 `examples/` 目录获取更多完整示例代码：

- `examples/basic_usage.py` - 基础使用
- `examples/advanced_rag.py` - 高级RAG应用
- `examples/api_integration.py` - API集成
- `examples/batch_processing.py` - 批量处理
- `examples/custom_interfaces.py` - 自定义接口

## 最佳实践

1. **知识库管理**
   - 定期更新文档
   - 使用适当的chunk_size
   - 为不同主题创建独立知识库

2. **对话优化**
   - 编写清晰的system_prompt
   - 根据需求调整temperature
   - 使用合适的模型

3. **接口设计**
   - 遵循RESTful规范
   - 添加详细的参数描述
   - 实现错误处理

4. **性能优化**
   - 使用缓存减少重复请求
   - 批量处理提高效率
   - 合理设置同步频率

## 问题反馈

如有问题或建议，请提交Issue或联系技术支持。

