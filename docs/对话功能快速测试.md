# CoreMind 对话功能快速测试指南

## 测试目标

验证新的对话助手配置功能是否正常工作。

## 前置条件

- 后端服务运行在 http://localhost:8000
- 前端服务运行在 http://localhost:5173
- 已注册并登录用户账号（如：coremind/coremind123）

## 测试步骤

### 第一步：创建LLM配置

1. 访问 http://localhost:5173/llm-configs
2. 点击"添加LLM配置"
3. 填写表单：
   ```
   配置名称: 测试GPT模型
   供应商: OpenAI (GPT-3.5/4)
   模型名称: gpt-4o（可以手动输入或选择）
   API密钥: sk-test（测试用，实际使用时填写真实密钥）
   API基础URL: https://api.openai.com/v1
   温度参数: 0.7
   最大Token数: 2000
   ```
4. 点击"确定"
5. **验证**：列表中应该出现刚创建的配置

### 第二步：创建助手配置

1. 访问 http://localhost:5173/assistants
2. 点击"添加AI助手"
3. 填写表单：
   ```
   助手名称: 测试助手
   助手描述: 这是一个用于测试的AI助手
   选择LLM配置: 测试GPT模型（从下拉列表选择）
   系统提示词: 你是一个友好的AI助手，负责回答用户的问题。
   
   功能开关:
   ☑ 启用知识库检索
   ☑ 启用数据源查询
   ☑ 启用接口调用
   ☑ 启用智能路由
   ```
4. 点击"确定"
5. **验证**：列表中应该出现刚创建的助手配置

### 第三步：创建对话

1. 访问 http://localhost:5173/chat
2. 点击"新建对话"按钮
3. 填写表单：
   ```
   对话标题: 测试对话
   选择助手: 测试助手（从下拉列表选择）
   系统提示词: （可留空，使用助手默认提示词）
   ```
4. 点击"确定"
5. **验证**：
   - 左侧对话列表应该出现"测试对话"
   - 对话自动被选中

### 第四步：发送消息

1. 在输入框中输入测试消息：
   ```
   你好！请介绍一下你自己。
   ```
2. 点击"发送"按钮或按Enter
3. **验证**：
   - 用户消息立即显示在右侧
   - 几秒后，AI助手的回复出现
   - 回复内容应该包含：
     - 助手名称（测试助手）
     - 使用的模型（gpt-4o）
     - 启用的功能（知识库、数据源、接口、智能路由）
     - 说明这是演示回复

### 第五步：测试对话历史

1. 继续发送几条消息：
   ```
   消息1: 你能做什么？
   消息2: 告诉我更多关于你的功能
   ```
2. **验证**：
   - 所有消息按顺序显示
   - 可以上下滚动查看历史

### 第六步：测试对话切换

1. 点击"新建对话"创建第二个对话
2. 填写信息并创建
3. 在两个对话之间切换
4. **验证**：
   - 切换时消息历史正确显示
   - 每个对话的消息独立

## 预期结果

### 成功标志

✅ LLM配置成功创建并显示在列表中
✅ 助手配置成功创建并显示在列表中  
✅ 对话成功创建并出现在左侧列表
✅ 消息发送后立即显示
✅ AI回复在几秒内返回
✅ 回复内容包含助手配置信息
✅ 对话历史正确保存和显示
✅ 对话切换功能正常

### 当前限制说明

**注意**：当前版本的AI回复是演示性的，会返回类似以下格式的内容：

```
您好！我是AI助手「测试助手」。

您的问题是：你好！请介绍一下你自己。

当前助手配置：
- 使用模型：gpt-4o
- 知识库：已启用
- 数据源：已启用
- 接口调用：已启用
- 智能路由：已启用

(这是演示回复。实际使用时，系统会：
1. 通过智能路由分析您的问题
2. 自动选择合适的工具（知识库/数据源/接口）
3. 调用配置的LLM模型生成专业回复)
```

这是正常的！因为当前版本尚未集成真实的LLM API调用。

## 故障排除

### 问题1：助手列表为空

**原因**：未创建LLM配置或助手配置  
**解决**：先完成第一步和第二步

### 问题2：创建对话时没有助手可选

**原因**：未创建助手配置或助手配置未激活  
**解决**：
1. 访问 /assistants 页面
2. 确认至少有一个助手配置
3. 确认助手配置的"是否启用"为"是"

### 问题3：发送消息后没有响应

**原因**：后端服务可能未运行  
**解决**：
```bash
# 检查后端服务
curl http://localhost:8000/health

# 如果失败，查看日志
tail -f /Users/gao/Documents/小目标/CoreMind/backend/backend.log

# 重启后端
cd /Users/gao/Documents/小目标/CoreMind/backend
python main.py
```

### 问题4：助手配置时找不到LLM配置

**原因**：LLM配置未创建或API调用失败  
**解决**：
1. 先访问 /llm-configs 页面创建LLM配置
2. 检查浏览器控制台是否有错误
3. 检查后端日志是否有错误

### 问题5：对话列表为空

**原因**：API调用失败或数据库问题  
**解决**：
```bash
# 检查数据库连接
docker ps | grep postgres

# 查看后端日志
tail -f /Users/gao/Documents/小目标/CoreMind/backend/backend.log

# 检查数据库表
docker exec -it coremind-postgres psql -U coremind -d coremind -c "\dt"
```

## 数据验证

### 检查数据库中的数据

```bash
# 连接数据库
docker exec -it coremind-postgres psql -U coremind -d coremind

# 查看LLM配置
SELECT id, name, provider, model_name, is_active FROM llm_configs;

# 查看助手配置
SELECT id, name, llm_config_id, enable_knowledge_base, enable_datasource, 
       enable_interface, auto_route, is_active 
FROM assistant_configs;

# 查看对话
SELECT id, title, assistant_id, model, created_at 
FROM conversations 
ORDER BY created_at DESC 
LIMIT 5;

# 查看消息
SELECT c.title, m.role, m.content, m.created_at 
FROM messages m 
JOIN conversations c ON m.conversation_id = c.id 
ORDER BY m.created_at DESC 
LIMIT 10;
```

## API测试

使用curl测试API端点：

```bash
# 登录获取token
TOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=coremind&password=coremind123" \
  | jq -r '.access_token')

# 获取助手列表
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/v1/assistants

# 获取对话列表
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/v1/chat-v2/conversations

# 创建对话（需要替换assistant_id）
curl -X POST http://localhost:8000/api/v1/chat-v2/conversations \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "API测试对话",
    "assistant_id": "your-assistant-id-here"
  }'
```

## 性能测试

### 响应时间

- 创建对话：< 1秒
- 发送消息：< 3秒（演示版本）
- 加载对话列表：< 1秒
- 加载消息历史：< 1秒

### 并发测试

可以开多个浏览器标签页，同时创建和使用对话，验证：
- 数据隔离正确
- 没有冲突
- 性能稳定

## 下一步

测试成功后，可以：

1. **集成真实LLM**
   - 配置真实的API密钥
   - 实现LLM服务调用
   - 测试流式输出

2. **添加知识库**
   - 上传文档到知识库
   - 测试知识库检索
   - 验证智能路由

3. **配置数据源**
   - 添加数据库连接
   - 填写使用规范
   - 测试数据查询

4. **创建接口**
   - 定义自定义接口
   - 测试接口调用
   - 验证参数传递

## 总结

完成以上测试后，您应该能够：
- ✅ 创建和管理LLM配置
- ✅ 创建和管理助手配置
- ✅ 使用助手创建对话
- ✅ 发送消息并接收回复
- ✅ 查看对话历史
- ✅ 切换多个对话

这确认了对话助手配置功能的基本框架已经正常工作！

## 反馈

测试中如有问题，请记录：
- 操作步骤
- 错误信息
- 浏览器控制台日志
- 后端日志相关部分

以便快速定位和修复问题。

