# CoreMind 对话助手配置功能说明

## 功能概述

CoreMind现在支持通过助手配置来创建智能对话，让用户可以使用预先配置好的AI助手进行对话。这个功能整合了LLM配置、知识库、数据源和接口，实现了真正的智能对话系统。

## 核心功能

### 1. 对话创建流程变更

**之前**：
- 创建对话时需要手动选择模型、知识库
- 需要手动输入系统提示词
- 配置分散，不易复用

**现在**：
- 创建对话时直接选择助手配置
- 助手配置包含了所有必要设置
- 一键创建，配置自动应用

### 2. 助手配置驱动

每个对话都关联一个助手配置，助手配置包含：

```
助手配置
├── LLM模型选择（GPT-4、DeepSeek、通义千问等）
├── 知识库范围（可选择多个知识库）
├── 数据源权限（可访问的数据库/API）
├── 接口调用权限（可执行的操作）
├── 系统提示词（定义助手行为）
└── 智能路由开关（自动选择工具）
```

### 3. 智能对话流程

```
用户提问
    ↓
选择助手配置
    ↓
创建/进入对话
    ↓
发送消息
    ↓
智能路由分析（如果启用）
    ├── 需要知识库？ → 检索相关文档
    ├── 需要数据源？ → 查询数据库/API
    ├── 需要调用接口？ → 执行操作
    └── 直接回答？ → 调用LLM
    ↓
生成回复
```

## 使用指南

### 前置条件

在创建对话之前，请确保已完成以下配置：

1. **LLM配置** (`/llm-configs`)
   - 配置至少一个LLM模型
   - 填写API密钥和相关参数
   - 示例：OpenAI GPT-4、DeepSeek Chat等

2. **助手配置** (`/assistants`)
   - 创建助手配置
   - 选择LLM模型
   - 配置功能权限（知识库、数据源、接口）
   - 编写系统提示词

### 创建对话步骤

1. **进入对话页面**
   - 点击左侧菜单"对话"

2. **新建对话**
   - 点击"新建对话"按钮
   - 输入对话标题（如"技术支持对话"）
   - **选择助手**：从下拉列表选择预配置的助手
   - 系统提示词（可选）：可覆盖助手默认提示词

3. **开始对话**
   - 输入问题
   - 系统会根据助手配置自动处理
   - 查看AI回复

### 功能示例

#### 示例1：技术文档助手

```yaml
助手名称: 技术文档助手
LLM模型: GPT-4
知识库: 启用（包含产品文档、API文档）
数据源: 禁用
接口调用: 禁用
系统提示词: |
  你是一个专业的技术文档助手。
  你可以查询知识库中的产品文档和API文档，
  为用户提供准确的技术信息和代码示例。
智能路由: 启用
```

**用户提问**：
> "如何使用用户认证API？"

**系统行为**：
1. 智能路由识别为知识库查询
2. 在知识库中搜索相关API文档
3. LLM基于检索到的文档生成详细回答

#### 示例2：数据查询助手

```yaml
助手名称: 数据查询助手
LLM模型: DeepSeek Chat
知识库: 禁用
数据源: 启用（包含用户数据库、订单数据库）
接口调用: 禁用
系统提示词: |
  你是一个数据查询助手。
  你可以查询用户数据库和订单数据库，
  帮助用户获取业务数据和生成报表。
智能路由: 启用
```

**用户提问**：
> "查询今天的订单数量"

**系统行为**：
1. 智能路由识别为数据源查询
2. 根据数据源的使用规范构造SQL查询
3. 执行查询并返回结果
4. LLM格式化并解释结果

#### 示例3：综合智能助手

```yaml
助手名称: 综合智能助手
LLM模型: GPT-4
知识库: 启用（产品知识库）
数据源: 启用（业务数据库）
接口调用: 启用（邮件发送、任务创建）
系统提示词: |
  你是一个全能的智能助手。
  你可以查询知识库、访问数据库、执行操作。
  请根据用户需求自动选择合适的工具。
智能路由: 启用
```

**用户提问**：
> "查询昨天销售额超过10000的订单，并发邮件通知财务部门"

**系统行为**：
1. 智能路由识别需要数据源+接口
2. 查询数据库获取订单
3. 调用邮件接口发送通知
4. LLM生成执行报告

## 技术实现

### 前端改动

1. **Chat.tsx**
   - 使用`chatV2API`替代`chatAPI`
   - 添加助手选择功能
   - 简化对话创建表单

2. **api.ts**
   - 新增`assistantAPI`
   - 新增`chatV2API`
   - 保持向后兼容

### 后端改动

1. **chat_v2.py**
   - 新增对话API V2端点
   - 支持助手配置
   - 集成智能路由（待完善）

2. **conversation模型**
   - 添加`assistant_id`字段
   - 关联助手配置

3. **数据库迁移**
   - 添加`assistant_id`列
   - 添加外键约束

## API接口

### 创建对话

```http
POST /api/v1/chat-v2/conversations
Content-Type: application/json
Authorization: Bearer {token}

{
  "title": "新对话",
  "assistant_id": "uuid",
  "system_prompt": "可选，覆盖助手默认提示词"
}
```

### 发送消息

```http
POST /api/v1/chat-v2/conversations/{conversation_id}/messages
Content-Type: application/json
Authorization: Bearer {token}

{
  "message": "用户问题",
  "stream": false
}
```

### 获取对话列表

```http
GET /api/v1/chat-v2/conversations
Authorization: Bearer {token}
```

### 获取对话消息

```http
GET /api/v1/chat-v2/conversations/{conversation_id}/messages
Authorization: Bearer {token}
```

## 下一步开发

### 待完善功能

1. **智能路由完整实现**
   - [ ] 实现真实的LLM决策逻辑
   - [ ] 支持Function Calling
   - [ ] 多工具组合使用

2. **LLM服务集成**
   - [ ] 实现LLMService
   - [ ] 支持多种LLM提供商
   - [ ] 实现流式输出

3. **工具调用**
   - [ ] 知识库检索集成
   - [ ] 数据源查询执行
   - [ ] 接口调用执行

4. **增强功能**
   - [ ] 对话历史管理
   - [ ] 消息编辑和重试
   - [ ] 导出对话记录
   - [ ] 对话模板

5. **UI优化**
   - [ ] Markdown渲染优化
   - [ ] 代码高亮
   - [ ] 流式输出动画
   - [ ] 工具调用可视化

## 配置示例

### 创建一个技术支持助手

1. **配置LLM**（LLM配置页面）
   ```
   名称: GPT-4主力模型
   提供商: OpenAI
   模型: gpt-4o
   API密钥: sk-xxx
   温度: 0.7
   最大Token: 4000
   ```

2. **配置助手**（助手配置页面）
   ```
   名称: 技术支持助手
   描述: 提供产品技术支持
   LLM模型: GPT-4主力模型
   
   功能配置:
   ✓ 启用知识库 → 选择"产品文档"、"常见问题"
   ✓ 启用数据源 → 选择"工单数据库"
   ✓ 启用接口调用 → 选择"创建工单"、"发送通知"
   ✓ 启用智能路由
   
   系统提示词:
   你是一个专业的技术支持助手。
   你可以查询产品文档、检索工单历史、创建新工单。
   请礼貌、专业地回答用户问题。
   ```

3. **创建对话**（对话页面）
   ```
   标题: 客户A的技术咨询
   助手: 技术支持助手
   ```

## 注意事项

1. **助手配置必须先创建**
   - 对话创建时必须选择助手
   - 如果没有助手配置，需要先创建

2. **LLM配置必须有效**
   - 助手关联的LLM配置必须存在
   - API密钥必须有效

3. **权限控制**
   - 只能使用自己创建的助手配置
   - 对话只能访问助手配置允许的资源

4. **当前限制**
   - 智能路由为演示版本，返回模拟数据
   - 实际LLM调用尚未实现
   - 工具调用结果为模拟数据

## 测试建议

### 测试流程

1. **创建LLM配置**
   - 配置OpenAI或其他可用模型
   - 验证API密钥有效性

2. **创建助手配置**
   - 选择刚创建的LLM配置
   - 配置功能权限
   - 编写系统提示词

3. **创建对话**
   - 选择助手
   - 输入测试问题

4. **验证功能**
   - 检查消息是否正确保存
   - 查看对话历史
   - 测试不同类型的问题

### 预期结果

当前版本会返回演示性回复，说明：
- 使用的助手配置
- 启用的功能
- 模型信息
- 智能路由状态

## 更新日志

### 2025-11-12
- ✅ 添加助手配置支持
- ✅ 实现对话V2 API
- ✅ 前端集成助手选择
- ✅ 数据库添加assistant_id字段
- ✅ 创建迁移脚本
- 🔄 智能路由（演示版本）
- 🔄 LLM服务集成（开发中）

## 相关文档

- [LLM配置说明](./模型手动输入功能说明.md)
- [助手配置说明](./新功能使用指南.md)
- [API文档](./API文档.md)
- [系统设计文档](./系统设计文档.md)

## 支持

如有问题，请查看：
- 后端日志: `backend/backend.log`
- 前端日志: `frontend/frontend.log`
- 数据库日志: `docker logs coremind-postgres`

