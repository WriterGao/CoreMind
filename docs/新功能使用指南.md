# CoreMind 新功能使用指南

## 📋 功能概览

本次更新增加了以下核心功能：

1. **多模型配置支持** - 支持GPT、DeepSeek、阿里通义千问等多种大模型
2. **助手配置模块** - 可自定义助手的模型、知识库和数据源
3. **数据源使用规范** - 为数据源添加使用文档，供AI参考
4. **智能路由** - 自动识别用户意图，调用相应的知识库或数据源

---

## 🤖 1. LLM模型配置

### 1.1 支持的模型提供商

| 提供商 | 说明 | 模型示例 |
|--------|------|----------|
| **OpenAI** | GPT系列模型 | gpt-3.5-turbo, gpt-4, gpt-4o |
| **Azure OpenAI** | 微软Azure托管的OpenAI | gpt-35-turbo, gpt-4 |
| **DeepSeek** | DeepSeek大模型 | deepseek-chat, deepseek-coder |
| **阿里通义千问** | 阿里云大模型 | qwen-turbo, qwen-plus, qwen-max |
| **智谱AI** | ChatGLM系列 | glm-4, glm-3-turbo |
| **百度文心** | 文心一言 | ernie-bot, ernie-bot-4 |
| **月之暗面** | Kimi大模型 | moonshot-v1-8k/32k/128k |
| **Anthropic** | Claude系列 | claude-3-opus/sonnet/haiku |
| **Google Gemini** | Gemini系列 | gemini-pro |
| **Ollama** | 本地部署模型 | llama2, mistral, qwen |
| **自定义** | 兼容OpenAI API的自定义模型 | - |

### 1.2 API端点

#### 获取支持的提供商列表
```bash
GET /api/v1/llm-configs/providers/list
```

**响应示例:**
```json
{
  "providers": [
    {
      "value": "openai",
      "label": "OpenAI (GPT-3.5/4)",
      "models": ["gpt-3.5-turbo", "gpt-4", "gpt-4-turbo", "gpt-4o"],
      "default_base": "https://api.openai.com/v1"
    }
  ]
}
```

#### 创建LLM配置
```bash
POST /api/v1/llm-configs
```

**请求体:**
```json
{
  "name": "我的GPT-4配置",
  "provider": "openai",
  "model_name": "gpt-4",
  "api_key": "sk-xxx",
  "api_base": "https://api.openai.com/v1",
  "temperature": 0.7,
  "max_tokens": 2000,
  "is_default": true
}
```

#### 获取所有LLM配置
```bash
GET /api/v1/llm-configs
Authorization: Bearer <token>
```

#### 更新LLM配置
```bash
PUT /api/v1/llm-configs/{config_id}
```

#### 删除LLM配置
```bash
DELETE /api/v1/llm-configs/{config_id}
```

### 1.3 使用示例

**1. 配置OpenAI:**
```bash
curl -X POST http://localhost:8000/api/v1/llm-configs \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "GPT-4",
    "provider": "openai",
    "model_name": "gpt-4",
    "api_key": "sk-your-api-key",
    "temperature": 0.7,
    "is_default": true
  }'
```

**2. 配置DeepSeek:**
```bash
curl -X POST http://localhost:8000/api/v1/llm-configs \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "DeepSeek",
    "provider": "deepseek",
    "model_name": "deepseek-chat",
    "api_key": "your-deepseek-key",
    "api_base": "https://api.deepseek.com/v1"
  }'
```

**3. 配置阿里通义千问:**
```bash
curl -X POST http://localhost:8000/api/v1/llm-configs \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "通义千问",
    "provider": "alibaba_qwen",
    "model_name": "qwen-max",
    "api_key": "your-dashscope-key",
    "api_base": "https://dashscope.aliyuncs.com/api/v1"
  }'
```

---

## 🎯 2. 助手配置

### 2.1 创建助手

助手配置允许您为不同场景创建专门的AI助手，每个助手可以：
- 使用指定的LLM模型
- 访问特定的知识库
- 调用特定的数据源
- 使用特定的接口

#### API端点
```bash
POST /api/v1/assistants
```

**请求体:**
```json
{
  "name": "技术支持助手",
  "description": "专门处理技术问题的AI助手",
  "llm_config_id": "llm-config-uuid",
  "system_prompt": "你是一个专业的技术支持工程师...",
  "knowledge_base_ids": ["kb-uuid-1", "kb-uuid-2"],
  "datasource_ids": ["ds-uuid-1"],
  "interface_ids": ["if-uuid-1"],
  "enable_knowledge_base": true,
  "enable_datasource": true,
  "enable_interface": true,
  "auto_route": true,
  "max_history": 10,
  "is_default": false
}
```

### 2.2 使用示例

**场景1: 客服助手（只使用知识库）**
```json
{
  "name": "客服助手",
  "description": "基于公司知识库回答客户问题",
  "llm_config_id": "gpt-4-config-id",
  "system_prompt": "你是一个友好的客服代表，请根据知识库内容准确回答客户问题。",
  "knowledge_base_ids": ["产品手册", "FAQ"],
  "enable_knowledge_base": true,
  "enable_datasource": false,
  "enable_interface": false,
  "auto_route": true
}
```

**场景2: 数据分析助手（可查询数据库）**
```json
{
  "name": "数据分析助手",
  "description": "帮助分析业务数据",
  "llm_config_id": "gpt-4-config-id",
  "system_prompt": "你是一个数据分析专家，可以查询数据库并提供洞察。",
  "datasource_ids": ["业务数据库", "日志数据库"],
  "enable_knowledge_base": false,
  "enable_datasource": true,
  "enable_interface": false,
  "auto_route": true
}
```

**场景3: 全能助手（所有功能）**
```json
{
  "name": "全能助手",
  "description": "可以回答问题、查询数据和执行操作",
  "llm_config_id": "gpt-4-config-id",
  "system_prompt": "你是一个全能AI助手。",
  "knowledge_base_ids": ["所有知识库"],
  "datasource_ids": ["所有数据源"],
  "interface_ids": ["所有接口"],
  "enable_knowledge_base": true,
  "enable_datasource": true,
  "enable_interface": true,
  "auto_route": true,
  "is_default": true
}
```

---

## 📚 3. 数据源使用规范

### 3.1 新增字段

数据源现在支持以下新字段，帮助AI更好地理解和使用数据源：

- **usage_doc**: 使用规范文档（文本）
- **schema_info**: 结构信息（JSON格式）
- **examples**: 使用示例（JSON数组）

### 3.2 数据库数据源示例

```json
{
  "name": "用户数据库",
  "type": "database",
  "config": {
    "host": "localhost",
    "port": 5432,
    "database": "myapp",
    "username": "admin",
    "password": "***"
  },
  "usage_doc": "本数据库包含用户信息和订单数据。查询时请注意：\n1. users表存储用户基本信息\n2. orders表存储订单信息\n3. 使用JOIN时注意性能\n4. 敏感字段（如密码）不要查询",
  "schema_info": {
    "tables": [
      {
        "name": "users",
        "columns": [
          {"name": "id", "type": "uuid", "description": "用户ID"},
          {"name": "username", "type": "varchar(50)", "description": "用户名"},
          {"name": "email", "type": "varchar(100)", "description": "邮箱"},
          {"name": "created_at", "type": "timestamp", "description": "创建时间"}
        ],
        "indexes": ["username", "email"]
      },
      {
        "name": "orders",
        "columns": [
          {"name": "id", "type": "uuid", "description": "订单ID"},
          {"name": "user_id", "type": "uuid", "description": "用户ID（外键）"},
          {"name": "amount", "type": "decimal(10,2)", "description": "订单金额"},
          {"name": "status", "type": "varchar(20)", "description": "订单状态"},
          {"name": "created_at", "type": "timestamp", "description": "下单时间"}
        ]
      }
    ]
  },
  "examples": [
    {
      "description": "查询用户总数",
      "query": "SELECT COUNT(*) FROM users"
    },
    {
      "description": "查询某用户的所有订单",
      "query": "SELECT * FROM orders WHERE user_id = 'xxx' ORDER BY created_at DESC"
    },
    {
      "description": "统计每日订单金额",
      "query": "SELECT DATE(created_at) as date, SUM(amount) as total FROM orders GROUP BY DATE(created_at)"
    }
  ]
}
```

### 3.3 API接口数据源示例

```json
{
  "name": "天气API",
  "type": "api",
  "config": {
    "base_url": "https://api.weather.com/v1",
    "auth_type": "api_key",
    "api_key": "xxx"
  },
  "usage_doc": "天气查询API。支持查询全球城市的实时天气和天气预报。\n限制：\n- 每分钟最多100次请求\n- 需要提供城市名称或经纬度\n- 返回JSON格式数据",
  "schema_info": {
    "endpoints": [
      {
        "path": "/weather/current",
        "method": "GET",
        "params": [
          {"name": "city", "type": "string", "required": true, "description": "城市名称"},
          {"name": "units", "type": "string", "default": "metric", "description": "单位：metric(摄氏度)/imperial(华氏度)"}
        ],
        "response": {
          "temperature": "number",
          "humidity": "number",
          "description": "string"
        }
      }
    ]
  },
  "examples": [
    {
      "description": "查询北京天气",
      "request": "GET /weather/current?city=Beijing&units=metric"
    }
  ]
}
```

---

## 🧠 4. 智能路由

### 4.1 工作原理

智能路由会根据用户问题自动判断应该：
- 使用知识库检索（回答概念性问题）
- 查询数据源（获取数据）
- 调用接口（执行操作）

判断依据包括：
- 问题中的关键词
- 问题的语义特征
- 助手的配置

### 4.2 关键词分类

**知识库关键词:**
- 什么是、介绍、解释、说明、概念、定义
- 怎么样、如何、为什么、原理、背景
- 文档、资料、信息、内容、知识

**数据查询关键词:**
- 查询、统计、数量、多少、几个、列表
- 数据、记录、条目、信息、详情
- 最新、最近、历史、时间、日期

**接口调用关键词:**
- 调用、执行、运行、处理、操作
- 创建、新建、添加、插入
- 修改、更新、编辑、改变
- 删除、移除、清除

### 4.3 使用新的聊天API

```bash
POST /api/v1/chat-v2/chat
```

**请求体:**
```json
{
  "message": "最近一周有多少新用户注册？",
  "assistant_id": "assistant-uuid",
  "conversation_id": "conversation-uuid"  // 可选，不提供则创建新会话
}
```

**响应:**
```json
{
  "conversation_id": "conv-uuid",
  "message_id": "msg-uuid",
  "role": "assistant",
  "content": "AI的回复内容...",
  "route_info": {
    "route_type": "datasource",
    "confidence": 0.85,
    "reason": "检测到数据查询意图，使用数据源查询",
    "services": [
      {
        "type": "datasource",
        "id": "ds-uuid",
        "name": "用户数据库",
        "usage_doc": "..."
      }
    ]
  }
}
```

### 4.4 示例对话

**示例1: 知识库问题**
```
用户: "什么是RESTful API？"

路由结果:
- route_type: knowledge_base
- confidence: 0.92
- reason: 检测到知识查询意图，使用知识库检索

AI回复: 基于技术文档知识库的内容回答...
```

**示例2: 数据查询**
```
用户: "查询最近7天的订单统计"

路由结果:
- route_type: datasource
- confidence: 0.88
- reason: 检测到数据查询意图，使用数据源查询

AI回复: 
根据数据源使用规范，我构造了以下查询：
SELECT DATE(created_at) as date, COUNT(*) as count, SUM(amount) as total
FROM orders
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at)

查询结果显示...
```

**示例3: 混合场景**
```
用户: "帮我创建一个新用户，用户名是test"

路由结果:
- route_type: interface
- confidence: 0.76
- reason: 检测到操作执行意图，使用接口调用

AI回复: 我将调用用户创建接口...
```

---

## 🔧 5. 配置建议

### 5.1 生产环境配置

**1. 添加ENCRYPTION_KEY到.env**
```bash
# 生成加密密钥
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# 添加到.env
ENCRYPTION_KEY=your-generated-key
```

**2. 配置默认助手**
- 为不同用户场景创建多个助手
- 为常用场景设置默认助手
- 定期更新助手的system_prompt以优化效果

### 5.2 性能优化

**1. 知识库优化**
- 保持知识库内容精简和更新
- 使用合适的chunk大小
- 定期重建向量索引

**2. 数据源优化**
- 提供详细的schema_info和examples
- 优化数据库查询性能
- 设置合理的超时时间

**3. 路由优化**
- 根据实际使用情况调整关键词
- 收集用户反馈优化路由准确率
- 必要时禁用auto_route手动指定

---

## 📊 6. 监控和调试

### 6.1 查看路由决策

每次对话的响应中都包含`route_info`，可用于：
- 了解AI的决策过程
- 发现路由错误
- 优化助手配置

### 6.2 日志分析

后端日志中会记录：
- 路由决策详情
- 使用的服务
- 执行时间

### 6.3 常见问题

**Q: 为什么路由总是选择混合模式？**
A: 可能是问题关键词不明确，置信度太低。可以：
- 优化system_prompt，引导用户提供更明确的问题
- 调整关键词列表
- 禁用auto_route，手动控制

**Q: 如何强制使用特定服务？**
A: 设置助手配置时，只启用需要的服务：
```json
{
  "enable_knowledge_base": true,
  "enable_datasource": false,
  "enable_interface": false
}
```

**Q: API密钥安全吗？**
A: API密钥使用Fernet对称加密存储，只要ENCRYPTION_KEY不泄露就是安全的。

---

## 🎉 总结

通过这些新功能，CoreMind现在支持：

✅ **多模型** - 灵活选择适合的大模型  
✅ **多助手** - 为不同场景定制专门的AI助手  
✅ **智能路由** - 自动判断用户意图并调用合适的服务  
✅ **规范文档** - AI可以参考数据源的使用规范  

开始使用这些新功能，让您的AI助手更加智能和强大！

---

## 📞 支持

如有问题，请查看：
- API文档: http://localhost:8000/docs
- 项目文档: `/docs`目录
- 示例代码: `/docs/使用示例.md`

