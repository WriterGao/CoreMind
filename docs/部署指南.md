# CoreMind 部署指南

## 环境要求

### 最低配置
- CPU: 2核
- 内存: 4GB
- 磁盘: 20GB
- 操作系统: Linux/macOS/Windows

### 推荐配置
- CPU: 4核以上
- 内存: 8GB以上
- 磁盘: 50GB以上（SSD）
- 操作系统: Linux (Ubuntu 20.04+/CentOS 8+)

### 软件依赖
- Docker 20.10+
- Docker Compose 2.0+

## 开发环境部署

### 1. 克隆项目

```bash
git clone https://github.com/yourusername/CoreMind.git
cd CoreMind
```

### 2. 配置环境变量

复制环境变量模板:
```bash
cp .env.example .env
```

编辑 `.env` 文件，配置必要的参数:
```bash
# 数据库配置
DATABASE_URL=postgresql://coremind:password@localhost:5432/coremind
POSTGRES_USER=coremind
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=coremind

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT密钥（请修改为随机字符串）
SECRET_KEY=your-secret-key-at-least-32-characters-long

# OpenAI配置
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_MODEL=gpt-4
```

### 3. 启动服务

使用Docker Compose启动所有服务:
```bash
make dev
# 或
docker-compose up -d
```

等待服务启动完成后，访问:
- 前端: http://localhost:5173
- 后端API: http://localhost:8000
- API文档: http://localhost:8000/docs

### 4. 初始化数据库

```bash
make init-db
# 或
cd backend && python scripts/init_db.py
```

### 5. 创建第一个用户

访问前端注册页面: http://localhost:5173/register

或使用API创建:
```bash
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "email": "admin@example.com",
    "password": "admin123",
    "full_name": "管理员"
  }'
```

## 生产环境部署

### 1. 准备服务器

更新系统:
```bash
sudo apt update && sudo apt upgrade -y
```

安装Docker:
```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
```

安装Docker Compose:
```bash
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2. 配置生产环境变量

创建 `.env.prod` 文件:
```bash
# 数据库配置（使用强密码）
POSTGRES_USER=coremind
POSTGRES_PASSWORD=very_secure_password_here
POSTGRES_DB=coremind

# Redis密码
REDIS_PASSWORD=redis_secure_password

# JWT密钥（必须修改为强随机字符串）
SECRET_KEY=$(openssl rand -hex 32)

# OpenAI配置
OPENAI_API_KEY=sk-your-production-api-key

# 应用配置
DEBUG=False
LOG_LEVEL=WARNING
```

### 3. 使用生产环境配置启动

```bash
# 构建并启动
make prod-build
# 或
docker-compose -f docker-compose.prod.yml up -d --build
```

### 4. 配置Nginx反向代理（可选）

安装Nginx:
```bash
sudo apt install nginx -y
```

创建Nginx配置 `/etc/nginx/sites-available/coremind`:
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    client_max_body_size 100M;

    location / {
        proxy_pass http://localhost:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用配置:
```bash
sudo ln -s /etc/nginx/sites-available/coremind /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 5. 配置SSL证书（推荐）

使用Let's Encrypt:
```bash
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d yourdomain.com
```

### 6. 配置防火墙

```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

## 监控和维护

### 查看日志

```bash
# 所有服务日志
make logs

# 后端日志
make logs-backend

# 前端日志
make logs-frontend
```

### 备份数据库

```bash
# 自动备份
make backup-db

# 手动备份
docker-compose exec postgres pg_dump -U coremind coremind > backup.sql
```

### 恢复数据库

```bash
make restore-db FILE=backup.sql
```

### 更新服务

```bash
# 拉取最新代码
git pull origin main

# 重新构建并启动
make prod-build

# 或手动执行
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d --build
```

## 性能优化

### 1. 数据库优化

编辑PostgreSQL配置:
```bash
docker-compose exec postgres psql -U coremind
```

```sql
-- 增加连接池
ALTER SYSTEM SET max_connections = 200;
-- 增加共享内存
ALTER SYSTEM SET shared_buffers = '256MB';
-- 调整工作内存
ALTER SYSTEM SET work_mem = '16MB';
```

### 2. Redis优化

增加Redis内存限制:
```yaml
# docker-compose.prod.yml
redis:
  command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
```

### 3. 应用优化

调整Worker数量:
```dockerfile
# backend/Dockerfile.prod
CMD ["gunicorn", "main:app", \
     "--workers", "8",  # 根据CPU核心数调整
     "--worker-class", "uvicorn.workers.UvicornWorker", \
     ...
]
```

## 故障排查

### 服务无法启动

检查日志:
```bash
docker-compose logs backend
docker-compose logs postgres
```

常见问题:
1. 端口被占用 → 修改docker-compose.yml中的端口映射
2. 数据库连接失败 → 检查DATABASE_URL配置
3. 权限问题 → 检查数据卷权限

### 性能问题

1. 检查资源使用:
```bash
docker stats
```

2. 检查数据库性能:
```bash
docker-compose exec postgres psql -U coremind -c "SELECT * FROM pg_stat_activity;"
```

3. 查看慢查询日志

### 数据丢失

立即停止服务并恢复备份:
```bash
docker-compose down
make restore-db FILE=latest_backup.sql
docker-compose up -d
```

## 安全建议

1. ✅ 使用强密码
2. ✅ 启用HTTPS（SSL/TLS）
3. ✅ 定期更新系统和依赖
4. ✅ 限制API访问频率
5. ✅ 定期备份数据
6. ✅ 监控异常访问
7. ✅ 使用环境变量管理敏感信息
8. ✅ 定期审查日志

## 扩展部署

### 使用Kubernetes

准备中...

### 使用云服务

支持部署到:
- AWS (ECS/EKS)
- Google Cloud Platform (GKE)
- Azure (AKS)
- 阿里云
- 腾讯云

详细文档请参考云服务商文档。

## 技术支持

遇到问题？

1. 查看文档: `docs/`
2. 搜索Issues: GitHub Issues
3. 提交新Issue
4. 联系邮箱: support@coremind.com

