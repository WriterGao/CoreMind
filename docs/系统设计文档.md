# CoreMind 系统设计文档

## 1. 系统架构

### 1.1 整体架构

CoreMind采用前后端分离的微服务架构，主要包含以下几层：

```
┌─────────────────────────────────────────────────┐
│              表示层 (Presentation)              │
│         React + TypeScript + Ant Design         │
└─────────────────────────────────────────────────┘
                       ↕ REST API
┌─────────────────────────────────────────────────┐
│               应用层 (Application)              │
│              FastAPI + Pydantic                 │
└─────────────────────────────────────────────────┘
                       ↕
┌──────────────┬──────────────┬──────────────────┐
│  业务逻辑层  │   服务层      │    领域层        │
│  (Business)  │  (Services)   │   (Domain)       │
│              │               │                  │
│ • 数据源管理 │ • 文件解析   │ • 用户管理       │
│ • 知识库构建 │ • 向量化     │ • 权限控制       │
│ • 接口管理   │ • LLM调用    │ • 配置管理       │
│ • 对话引擎   │ • 工具执行   │                  │
└──────────────┴──────────────┴──────────────────┘
                       ↕
┌──────────────┬──────────────┬──────────────────┐
│   数据层     │    缓存层    │    向量层        │
│ (Data Store) │   (Cache)    │   (Vector)       │
│              │              │                  │
│ PostgreSQL   │    Redis     │   ChromaDB       │
└──────────────┴──────────────┴──────────────────┘
```

### 1.2 核心组件

#### 1.2.1 数据源管理模块
- **职责**: 连接和管理多种数据源
- **支持类型**: 本地文件、数据库、API、网页爬虫
- **设计模式**: 策略模式 + 工厂模式
- **关键类**: `BaseDataSource`, `LocalFileDataSource`, `DatabaseDataSource`

#### 1.2.2 知识库模块
- **职责**: 文档处理、向量化、相似度搜索
- **核心技术**: LangChain, ChromaDB, OpenAI Embeddings
- **设计模式**: 门面模式
- **关键类**: `VectorStore`, `EmbeddingService`, `TextSplitterService`

#### 1.2.3 接口自定义模块
- **职责**: 管理和执行自定义接口
- **支持类型**: Python函数、外部API、数据库操作、文件处理
- **设计模式**: 命令模式
- **关键类**: `InterfaceExecutor`, `ToolManager`

#### 1.2.4 AI助手核心
- **职责**: 对话管理、上下文记忆、知识检索
- **核心技术**: LangChain, OpenAI/Azure OpenAI
- **设计模式**: 建造者模式
- **关键类**: `ChatEngine`, `ConversationMemory`

## 2. 数据库设计

### 2.1 ER图

```
┌─────────────┐       ┌─────────────────┐       ┌──────────────────┐
│    users    │◄─────┤   datasources   │       │  knowledge_bases │
└─────────────┘       └─────────────────┘       └──────────────────┘
       │                                                  │
       │                                                  │
       ├──────────────────────────────────────────────────┘
       │                                                  
       │              ┌──────────────┐
       ├─────────────►│  documents   │
       │              └──────────────┘
       │                     │
       │              ┌──────────────────┐
       │              │ document_chunks  │
       │              └──────────────────┘
       │
       │              ┌────────────────────┐
       ├─────────────►│ custom_interfaces  │
       │              └────────────────────┘
       │
       │              ┌────────────────┐        ┌─────────────┐
       └─────────────►│ conversations  │◄──────┤  messages   │
                      └────────────────┘        └─────────────┘
```

### 2.2 核心表结构

#### users (用户表)
- id (UUID, PK)
- username (VARCHAR, UNIQUE)
- email (VARCHAR, UNIQUE)
- hashed_password (VARCHAR)
- full_name (VARCHAR)
- is_active (BOOLEAN)
- created_at (TIMESTAMP)

#### knowledge_bases (知识库表)
- id (UUID, PK)
- user_id (UUID, FK → users.id)
- name (VARCHAR)
- description (TEXT)
- embedding_model (VARCHAR)
- collection_name (VARCHAR, UNIQUE)
- chunk_size (INTEGER)
- chunk_overlap (INTEGER)
- total_documents (INTEGER)
- total_chunks (INTEGER)

#### documents (文档表)
- id (UUID, PK)
- knowledge_base_id (UUID, FK)
- title (VARCHAR)
- content (TEXT)
- file_path (VARCHAR)
- file_type (VARCHAR)
- metadata (JSON)
- chunk_count (INTEGER)
- is_processed (BOOLEAN)

### 2.3 索引策略

```sql
-- 用户相关
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- 知识库相关
CREATE INDEX idx_kb_user_id ON knowledge_bases(user_id);
CREATE INDEX idx_documents_kb_id ON documents(knowledge_base_id);
CREATE INDEX idx_chunks_kb_id ON document_chunks(knowledge_base_id);
CREATE INDEX idx_chunks_doc_id ON document_chunks(document_id);

-- 对话相关
CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_messages_conv_id ON messages(conversation_id);
CREATE INDEX idx_messages_created ON messages(created_at);

-- 数据源相关
CREATE INDEX idx_datasources_user_id ON datasources(user_id);
CREATE INDEX idx_datasources_type ON datasources(type);
```

## 3. API设计

### 3.1 API规范

- **风格**: RESTful
- **版本**: v1
- **Base URL**: `/api/v1`
- **认证**: JWT Bearer Token
- **响应格式**: JSON
- **错误处理**: 统一错误码和错误信息

### 3.2 API分组

1. **认证API** (`/auth`)
   - POST /register - 注册
   - POST /login - 登录
   - GET /me - 获取当前用户

2. **数据源API** (`/datasources`)
   - GET / - 列表
   - POST / - 创建
   - GET /{id} - 详情
   - DELETE /{id} - 删除
   - POST /{id}/sync - 同步

3. **知识库API** (`/knowledge`)
   - GET / - 列表
   - POST / - 创建
   - POST /{id}/upload - 上传文档
   - POST /{id}/search - 搜索

4. **接口API** (`/interfaces`)
   - GET / - 列表
   - POST / - 创建
   - POST /{id}/execute - 执行

5. **对话API** (`/chat`)
   - GET /conversations - 列表
   - POST /conversations - 创建
   - POST /conversations/{id}/messages - 发送消息

## 4. 数据流设计

### 4.1 文档处理流程

```
用户上传文档
    ↓
保存到本地存储
    ↓
文件解析器识别格式
    ↓
提取文本内容
    ↓
文本切分器分割
    ↓
生成嵌入向量
    ↓
存储到ChromaDB
    ↓
更新元数据到PostgreSQL
```

### 4.2 对话处理流程

```
用户发送消息
    ↓
加载对话历史
    ↓
检索知识库（可选）
    ↓
构建Prompt
    ↓
调用LLM
    ↓
流式返回/一次返回
    ↓
保存消息到数据库
    ↓
更新对话统计
```

### 4.3 知识检索流程

```
用户查询
    ↓
查询文本向量化
    ↓
ChromaDB相似度搜索
    ↓
获取Top-K结果
    ↓
重排序（可选）
    ↓
返回结果
```

## 5. 安全设计

### 5.1 认证授权

- **认证方式**: JWT (JSON Web Token)
- **Token过期**: 30分钟（可配置）
- **刷新机制**: 待实现
- **权限模型**: RBAC (基于角色的访问控制)

### 5.2 数据安全

- **密码**: bcrypt哈希
- **传输**: HTTPS (生产环境)
- **敏感信息**: 环境变量存储
- **文件上传**: 大小限制、类型检查

### 5.3 防护措施

- **SQL注入**: 使用ORM (SQLAlchemy)
- **XSS**: 前端输入验证和转义
- **CSRF**: SameSite Cookie
- **限流**: API限流中间件

## 6. 性能优化

### 6.1 缓存策略

- **Redis缓存**:
  - 用户会话
  - API响应缓存
  - 热门查询结果
  
### 6.2 数据库优化

- **连接池**: 最大100连接
- **慢查询日志**: >1秒
- **索引优化**: 基于查询模式
- **分页查询**: 避免全表扫描

### 6.3 向量存储优化

- **批量操作**: 批量插入和查询
- **内存限制**: 控制集合大小
- **预加载**: 常用集合预加载

## 7. 扩展性设计

### 7.1 水平扩展

- **无状态设计**: 应用层无状态
- **负载均衡**: Nginx反向代理
- **数据库读写分离**: 主从复制
- **消息队列**: Celery + Redis

### 7.2 插件机制

- **数据源插件**: 继承BaseDataSource
- **接口插件**: 自定义工具注册
- **模型插件**: 支持多种LLM

### 7.3 配置化

- **环境变量**: 12-Factor App
- **配置中心**: 支持动态配置
- **特性开关**: 功能开关控制

## 8. 监控和日志

### 8.1 日志系统

- **日志框架**: Loguru
- **日志级别**: DEBUG/INFO/WARNING/ERROR
- **日志轮转**: 每天轮转，保留30天
- **结构化日志**: JSON格式

### 8.2 监控指标

- **应用指标**:
  - API响应时间
  - 请求成功率
  - 并发连接数

- **资源指标**:
  - CPU使用率
  - 内存使用率
  - 磁盘I/O

- **业务指标**:
  - 用户活跃度
  - 知识库大小
  - 对话次数

### 8.3 告警机制

- **错误告警**: 错误率超过阈值
- **性能告警**: 响应时间过长
- **资源告警**: 资源使用率过高

## 9. 技术选型理由

### 9.1 后端技术栈

- **FastAPI**: 
  - 高性能（基于Starlette和Pydantic）
  - 自动API文档
  - 类型提示支持
  - 异步支持

- **SQLAlchemy**: 
  - 成熟的ORM
  - 异步支持
  - 灵活的查询接口

- **LangChain**: 
  - LLM应用开发框架
  - 丰富的组件生态
  - 活跃的社区

### 9.2 前端技术栈

- **React**: 
  - 组件化开发
  - 虚拟DOM性能优化
  - 丰富的生态系统

- **TypeScript**: 
  - 类型安全
  - 更好的IDE支持
  - 提高代码质量

- **Ant Design**: 
  - 企业级UI组件库
  - 开箱即用
  - 一致的设计语言

### 9.3 数据库选型

- **PostgreSQL**: 
  - 功能强大
  - ACID保证
  - JSON支持

- **Redis**: 
  - 高性能缓存
  - 丰富的数据结构
  - 持久化支持

- **ChromaDB**: 
  - 专为AI应用设计
  - 易于使用
  - Python原生支持

## 10. 未来规划

### 10.1 短期目标 (3个月)

- [ ] 完善测试覆盖率
- [ ] 添加更多数据源类型
- [ ] 优化向量检索性能
- [ ] 实现批量操作API

### 10.2 中期目标 (6个月)

- [ ] 多租户支持
- [ ] 知识图谱功能
- [ ] 工作流编排
- [ ] 移动端适配

### 10.3 长期目标 (1年)

- [ ] 支持私有化部署
- [ ] 企业级权限管理
- [ ] 可视化数据分析
- [ ] AI模型微调平台

## 附录

### A. 技术债务

1. 需要添加更完善的错误处理
2. 需要实现请求限流
3. 需要添加更多单元测试
4. 需要优化大文件上传

### B. 参考资料

- FastAPI文档: https://fastapi.tiangolo.com/
- LangChain文档: https://python.langchain.com/
- ChromaDB文档: https://docs.trychroma.com/
- React文档: https://react.dev/

