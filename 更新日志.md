# CoreMind 更新日志

## 版本 2.0.0 (2025-11-12)

### 🎉 重大功能更新

#### 1. 多模型配置支持

现在支持配置和使用多种大语言模型，包括：

- **OpenAI**: GPT-3.5, GPT-4, GPT-4 Turbo, GPT-4o
- **Azure OpenAI**: 企业级OpenAI服务
- **DeepSeek**: deepseek-chat, deepseek-coder
- **阿里云通义千问**: qwen-turbo, qwen-plus, qwen-max
- **智谱AI**: GLM-4, GLM-3-turbo
- **百度文心一言**: ernie-bot, ernie-bot-4
- **月之暗面(Kimi)**: moonshot-v1-8k/32k/128k
- **Anthropic Claude**: claude-3-opus/sonnet/haiku
- **Google Gemini**: gemini-pro
- **Ollama**: 本地部署的开源模型
- **自定义**: 支持任何兼容OpenAI API的模型

**新增API:**
- `POST /api/v1/llm-configs` - 创建LLM配置
- `GET /api/v1/llm-configs` - 获取所有配置
- `GET /api/v1/llm-configs/{id}` - 获取单个配置
- `PUT /api/v1/llm-configs/{id}` - 更新配置
- `DELETE /api/v1/llm-configs/{id}` - 删除配置
- `GET /api/v1/llm-configs/providers/list` - 获取支持的提供商列表

**特性:**
- ✅ API密钥加密存储
- ✅ 支持自定义API端点
- ✅ 灵活的模型参数配置（temperature, max_tokens等）
- ✅ 支持设置默认配置

#### 2. AI助手配置模块

创建可自定义的AI助手，为不同场景配置专门的助手。

**配置项:**
- 选择使用的LLM模型
- 指定可访问的知识库范围
- 指定可使用的数据源
- 指定可调用的接口
- 自定义system prompt
- 启用/禁用特定功能
- 自动路由开关

**新增API:**
- `POST /api/v1/assistants` - 创建助手配置
- `GET /api/v1/assistants` - 获取所有助手
- `GET /api/v1/assistants/{id}` - 获取单个助手
- `PUT /api/v1/assistants/{id}` - 更新助手
- `DELETE /api/v1/assistants/{id}` - 删除助手

**使用场景:**
- 📚 **客服助手** - 只使用知识库回答问题
- 📊 **数据分析助手** - 专注于数据查询和分析
- ⚙️ **运维助手** - 可以执行系统操作
- 🎯 **全能助手** - 综合使用所有功能

#### 3. 数据源使用规范

为数据源添加详细的使用文档，帮助AI更好地理解和使用数据源。

**新增字段:**
- `usage_doc` - 使用规范文档（文本格式）
- `schema_info` - 结构信息（JSON格式）
- `examples` - 使用示例（JSON数组）

**价值:**
- 📖 AI可以参考数据库表设计文档
- 📝 AI可以查看API接口文档
- 💡 AI可以学习示例查询
- 🎯 提高数据源调用的准确性

**示例:**
```json
{
  "usage_doc": "用户数据库，包含用户和订单信息...",
  "schema_info": {
    "tables": [
      {
        "name": "users",
        "columns": [
          {"name": "id", "type": "uuid"},
          {"name": "username", "type": "varchar(50)"}
        ]
      }
    ]
  },
  "examples": [
    {
      "description": "查询用户总数",
      "query": "SELECT COUNT(*) FROM users"
    }
  ]
}
```

#### 4. 智能路由系统

自动识别用户问题类型，智能选择使用知识库、数据源还是接口。

**路由类型:**
- **knowledge_base** - 回答概念性问题
- **datasource** - 查询和分析数据
- **interface** - 执行操作和调用接口
- **mixed** - 综合使用多种服务

**判断依据:**
- 关键词匹配
- 语义分析
- 置信度评分

**新增API:**
- `POST /api/v1/chat-v2/chat` - 使用智能路由的聊天接口
- `GET /api/v1/chat-v2/conversations` - 获取会话列表
- `GET /api/v1/chat-v2/conversations/{id}/messages` - 获取会话消息
- `DELETE /api/v1/chat-v2/conversations/{id}` - 删除会话

**特性:**
- ✅ 自动意图识别
- ✅ 多服务协同
- ✅ 置信度评分
- ✅ 决策过程透明（返回route_info）

---

### 🗄️ 数据库变更

#### 新增表

**llm_configs** - LLM配置表
```sql
CREATE TABLE llm_configs (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    name VARCHAR(100),
    provider VARCHAR(50),  -- 提供商
    model_name VARCHAR(100),
    api_key TEXT,  -- 加密存储
    api_base VARCHAR(500),
    config JSON,
    temperature FLOAT,
    max_tokens INTEGER,
    is_default BOOLEAN,
    is_active BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**assistant_configs** - 助手配置表
```sql
CREATE TABLE assistant_configs (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    name VARCHAR(100),
    description TEXT,
    llm_config_id UUID REFERENCES llm_configs(id),
    system_prompt TEXT,
    knowledge_base_ids UUID[],  -- 数组
    datasource_ids UUID[],  -- 数组
    interface_ids UUID[],  -- 数组
    enable_knowledge_base BOOLEAN,
    enable_datasource BOOLEAN,
    enable_interface BOOLEAN,
    auto_route BOOLEAN,
    max_history INTEGER,
    config JSON,
    is_default BOOLEAN,
    is_active BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 修改表

**datasources** - 数据源表新增字段
```sql
ALTER TABLE datasources ADD COLUMN usage_doc TEXT;
ALTER TABLE datasources ADD COLUMN schema_info JSON;
ALTER TABLE datasources ADD COLUMN examples JSON;
```

---

### 📦 依赖更新

新增依赖包：
```
cryptography==41.0.7  # API密钥加密
bcrypt==4.1.1         # 密码哈希
aiofiles==23.2.1      # 异步文件操作
aiomysql==0.2.0       # 异步MySQL客户端
motor==3.3.2          # 异步MongoDB客户端
```

---

### 🔄 迁移指南

#### 1. 更新依赖
```bash
cd backend
pip install -r requirements.txt
```

#### 2. 初始化数据库
```bash
cd backend
python scripts/init_db.py
```

#### 3. 配置加密密钥
```bash
# 生成加密密钥
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# 添加到.env文件
echo "ENCRYPTION_KEY=your-generated-key" >> .env
```

#### 4. 重启服务
```bash
# 使用Docker
docker compose down
docker compose up -d

# 或本地运行
cd backend
python main.py
```

---

### 📚 文档更新

新增文档：
- `docs/新功能使用指南.md` - 详细的功能使用指南
- `更新日志.md` - 版本更新记录

更新文档：
- `README.md` - 添加新功能说明
- `docs/API文档.md` - 添加新API接口文档

---

### 🐛 Bug修复

- 修复了密码哈希相关的问题（使用bcrypt替代passlib）
- 修复了UUID转字符串的序列化问题
- 修复了SQLAlchemy保留字段名冲突（metadata -> doc_metadata/msg_metadata）
- 修复了缺失的导入（Integer, Float等）

---

### ⚡ 性能优化

- API密钥使用加密存储，提高安全性
- 智能路由减少不必要的服务调用
- 数据源使用规范提高查询准确性

---

### 🔮 下一步计划

- [ ] 实现真实的LLM调用（目前返回示例响应）
- [ ] 添加流式响应支持
- [ ] 实现会话历史管理
- [ ] 添加路由策略自定义
- [ ] 支持多轮对话上下文
- [ ] 添加监控和分析面板
- [ ] 优化路由算法
- [ ] 添加A/B测试功能

---

### 💡 使用建议

1. **首次使用**
   - 先配置至少一个LLM模型
   - 创建一个默认助手
   - 为数据源添加使用规范

2. **生产环境**
   - 务必设置ENCRYPTION_KEY环境变量
   - 定期备份数据库
   - 监控API调用次数和成本

3. **优化建议**
   - 根据实际场景调整system_prompt
   - 收集用户反馈优化路由准确率
   - 定期更新知识库和使用规范

---

### 📞 支持

如有问题或建议，请：
- 查看 `docs/新功能使用指南.md`
- 访问 API文档: http://localhost:8000/docs
- 提交Issue到项目仓库

---

**感谢使用CoreMind！** 🎉

