# 问题修复说明

## 已修复的问题

### 问题1: 数据源加载失败 ✅

**原因分析:**
- 后端API响应模型缺少新增的字段定义

**修复内容:**
1. 更新 `DataSourceCreate` 模型，添加：
   - `usage_doc`: 使用规范文档
   - `schema_info`: 结构信息
   - `examples`: 使用示例

2. 更新 `DataSourceResponse` 模型，添加相同字段

3. 更新创建数据源时的字段赋值

**修改文件:**
- `/backend/app/api/datasource.py`

---

### 问题2: 数据源配置页面没有使用规范字段 ✅

**原因分析:**
- 前端DataSource页面的表单缺少新字段

**修复内容:**

#### 1. 添加表单字段

新增三个字段到创建表单：

**使用规范文档 (usage_doc)**
- 类型: 文本域
- 说明: 描述如何使用此数据源
- 示例: 数据库表设计、API接口文档等

**结构信息 (schema_info)**
- 类型: JSON文本域
- 说明: 数据库schema、API参数等结构信息
- 格式: JSON对象

**使用示例 (examples)**
- 类型: JSON文本域
- 说明: 提供使用示例
- 格式: JSON数组

#### 2. 添加详情查看功能

- 新增"详情"按钮
- 创建详情模态框
- 完整展示所有字段，包括新增的三个字段

#### 3. 优化JSON处理

- 自动解析JSON字段
- 错误处理和验证

**修改文件:**
- `/frontend/src/pages/DataSource.tsx`

---

## 测试步骤

### 1. 访问系统
```
http://localhost:5173
```

### 2. 登录
```
用户名: coremind
密码: coremind123
```

### 3. 测试数据源配置

#### 步骤1: 进入数据源页面
点击左侧菜单 **"数据源"**

#### 步骤2: 创建新数据源
1. 点击 **"添加数据源"** 按钮
2. 填写基本信息：
   ```
   名称: 测试数据库
   描述: 用于测试的数据库
   类型: 数据库
   ```

3. 填写配置（JSON格式）：
   ```json
   {
     "host": "localhost",
     "port": 5432,
     "database": "test_db",
     "username": "admin"
   }
   ```

4. **填写新增字段:**

   **使用规范文档:**
   ```
   这是测试数据库，包含以下表：
   1. users - 用户信息表
   2. orders - 订单表
   
   查询时请注意：
   - 避免全表扫描
   - 使用索引字段查询
   - JOIN操作注意性能
   ```

   **结构信息（JSON格式）:**
   ```json
   {
     "tables": [
       {
         "name": "users",
         "columns": [
           {"name": "id", "type": "uuid", "description": "用户ID"},
           {"name": "username", "type": "varchar(50)", "description": "用户名"},
           {"name": "email", "type": "varchar(100)", "description": "邮箱"}
         ]
       },
       {
         "name": "orders",
         "columns": [
           {"name": "id", "type": "uuid", "description": "订单ID"},
           {"name": "user_id", "type": "uuid", "description": "用户ID"},
           {"name": "amount", "type": "decimal(10,2)", "description": "金额"}
         ]
       }
     ]
   }
   ```

   **使用示例（JSON数组）:**
   ```json
   [
     {
       "description": "查询用户总数",
       "query": "SELECT COUNT(*) FROM users"
     },
     {
       "description": "查询某用户的订单",
       "query": "SELECT * FROM orders WHERE user_id = 'xxx'"
     },
     {
       "description": "统计订单总金额",
       "query": "SELECT SUM(amount) FROM orders"
     }
   ]
   ```

5. 点击 **"确定"** 创建

#### 步骤3: 查看详情
1. 在数据源列表中找到刚创建的数据源
2. 点击 **"详情"** 按钮
3. 确认以下内容正确显示：
   - ✅ 基本信息（名称、描述、类型）
   - ✅ 配置信息（JSON格式化显示）
   - ✅ **使用规范文档**（新增）
   - ✅ **结构信息**（新增，JSON格式化显示）
   - ✅ **使用示例**（新增，JSON格式化显示）
   - ✅ 状态和文档数

---

## 验证清单

### 数据源表单
- [ ] 能看到"使用规范文档"字段
- [ ] 能看到"结构信息"字段
- [ ] 能看到"使用示例"字段
- [ ] 每个字段都有提示说明（tooltip）
- [ ] 每个字段都有示例占位符

### 数据源创建
- [ ] 能成功创建带有新字段的数据源
- [ ] JSON字段能正确解析
- [ ] 必填字段验证正常
- [ ] 可选字段可以留空

### 数据源详情
- [ ] 能打开详情模态框
- [ ] 基本信息正确显示
- [ ] 配置信息格式化显示
- [ ] **使用规范文档正确显示**
- [ ] **结构信息格式化显示**
- [ ] **使用示例格式化显示**
- [ ] 未填写的字段不显示

### API测试
- [ ] GET `/api/v1/datasources` 返回包含新字段
- [ ] POST `/api/v1/datasources` 能接受新字段
- [ ] 新字段正确存储到数据库

---

## 技术细节

### 后端变更

**数据模型 (DataSource)**
```python
usage_doc = Column(Text, comment="使用规范文档")
schema_info = Column(JSON, comment="结构信息")
examples = Column(JSON, comment="使用示例")
```

**API模型**
```python
class DataSourceCreate(BaseModel):
    name: str
    description: str = ""
    type: DataSourceType
    config: dict
    usage_doc: str = ""           # 新增
    schema_info: dict = None      # 新增
    examples: list = None          # 新增
    sync_frequency: int = 0
```

### 前端变更

**新增状态**
```typescript
const [detailModalVisible, setDetailModalVisible] = useState(false)
const [selectedDatasource, setSelectedDatasource] = useState<any>(null)
```

**表单字段**
```tsx
<Form.Item name="usage_doc" label="使用规范文档">
  <TextArea rows={4} />
</Form.Item>

<Form.Item name="schema_info" label="结构信息（JSON格式）">
  <TextArea rows={6} />
</Form.Item>

<Form.Item name="examples" label="使用示例（JSON数组）">
  <TextArea rows={4} />
</Form.Item>
```

**JSON处理**
```typescript
const data = {
  ...values,
  config: JSON.parse(values.config),
  schema_info: values.schema_info ? JSON.parse(values.schema_info) : null,
  examples: values.examples ? JSON.parse(values.examples) : null,
}
```

---

## 使用场景

### 场景1: 数据库数据源

**使用规范文档:**
```
订单管理系统数据库

表说明：
- orders: 订单主表
- order_items: 订单明细表
- products: 产品表

查询规范：
1. 查询订单时必须加上时间范围
2. 关联查询使用LEFT JOIN
3. 统计数据使用索引字段
```

**结构信息:**
```json
{
  "tables": [
    {
      "name": "orders",
      "primary_key": "id",
      "indexes": ["user_id", "created_at"],
      "columns": [...]
    }
  ]
}
```

### 场景2: API数据源

**使用规范文档:**
```
天气查询API

接口说明：
- 支持按城市名查询
- 支持按经纬度查询
- 限流：100次/分钟

认证方式：API Key
```

**结构信息:**
```json
{
  "endpoints": [
    {
      "path": "/weather/current",
      "method": "GET",
      "params": {
        "city": {"type": "string", "required": true},
        "units": {"type": "string", "default": "metric"}
      }
    }
  ]
}
```

---

## 常见问题

### Q1: JSON字段格式错误怎么办？
**A:** 系统会提示"创建失败"，请检查JSON格式是否正确：
- 使用双引号，不要用单引号
- 对象用 `{}`，数组用 `[]`
- 可以使用在线JSON验证工具检查

### Q2: 是否必须填写新增的字段？
**A:** 不是必填的，可以留空：
- `usage_doc`: 可选，但强烈建议填写
- `schema_info`: 可选
- `examples`: 可选

### Q3: 如何查看AI是否使用了这些规范？
**A:** 在使用智能路由聊天时，查看响应中的 `route_info`，其中会包含数据源的使用规范信息。

### Q4: 已有的数据源需要更新吗？
**A:** 不需要。新字段为可选字段，已有数据源仍可正常使用。建议后续逐步为重要数据源添加规范文档。

---

## 下一步

1. ✅ 为现有数据源添加使用规范
2. ✅ 测试AI助手是否能正确使用规范
3. ✅ 在实际使用中收集反馈，优化规范模板

---

## 服务状态

- ✅ 后端服务: http://localhost:8000 (运行中)
- ✅ 前端服务: http://localhost:5173 (运行中)
- ✅ 数据库: PostgreSQL (已连接)

**所有问题已修复，可以正常使用！** 🎉

